<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¯Œå£«å±±ä¹‹æ—… - 12/13-12/14</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        fuji: {
                            blue: '#3777bc', // å¯Œå£«è—
                            white: '#ffffff', // é›ªç™½
                            grey: '#f4f4f6', // æš–ç°
                            text: '#2c3e50',
                            accent: '#e74c3c'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f0f4f8;
            background-image: radial-gradient(#dbeafe 1px, transparent 1px);
            background-size: 20px 20px;
        }
        /* Hide scrollbar for clean look */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        /* Mobile safe area */
        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
        /* Modal scroll fix */
        .modal-content {
            max-height: 85vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body class="text-fuji-text antialiased safe-bottom">

<!-- Full width layout: Changed max-w-3xl to w-full max-w-7xl for responsive full width feel -->
<div id="app" class="w-full max-w-7xl mx-auto min-h-screen bg-fuji-grey relative pb-24">

    <!-- Header -->
    <header class="bg-fuji-blue text-white p-4 sm:p-6 rounded-b-[20px] shadow-lg sticky top-0 z-10">
        <div class="flex justify-between items-center mb-3">
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold tracking-wider">ä¼Šè±†ã®æ—…</h1>
                <p class="text-blue-100 text-sm sm:text-base mt-1"><i class="fas fa-calendar-alt mr-2"></i>12/13 - 12/14</p>
            </div>
             <div class="bg-white/20 p-2 sm:p-3 rounded-full backdrop-blur-sm">
                <i class="fas fa-mountain text-xl sm:text-2xl"></i>
            </div>
        </div>

        <!-- Day Tabs with Weather -->
        <div class="flex space-x-2 mt-2">
            <button 
                @click="currentDay = '1'" 
                :class="['flex-1 py-2 sm:py-3 rounded-xl font-bold text-base sm:text-lg transition-all transform active:scale-95 flex items-center justify-center', currentDay === '1' ? 'bg-white text-fuji-blue shadow-md' : 'bg-fuji-blue/50 text-white/80']">
                <span>Day 1 (12/13)</span>
                <i class="fas fa-sun ml-2 text-orange-400"></i> <!-- Mock Weather -->
            </button>
            <button 
                @click="currentDay = '2'" 
                :class="['flex-1 py-2 sm:py-3 rounded-xl font-bold text-base sm:text-lg transition-all transform active:scale-95 flex items-center justify-center', currentDay === '2' ? 'bg-white text-fuji-blue shadow-md' : 'bg-fuji-blue/50 text-white/80']">
                <span>Day 2 (12/14)</span>
                <i class="fas fa-cloud-sun ml-2 text-yellow-300"></i> <!-- Mock Weather -->
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="p-2 sm:p-4 space-y-4">
        
        <div v-if="loading" class="text-center py-20">
            <i class="fas fa-circle-notch fa-spin text-4xl text-fuji-blue mb-4"></i>
            <p class="text-xl text-gray-500">è¡Œç¨‹è®€å–ä¸­...</p>
        </div>

        <div v-else-if="filteredData.length === 0" class="text-center py-20 opacity-50">
            <i class="fas fa-suitcase-rolling text-6xl text-gray-300 mb-4"></i>
            <p class="text-xl text-gray-500">æœ¬æ—¥æš«ç„¡è¡Œç¨‹</p>
        </div>

        <!-- Cards -->
        <div 
            v-for="item in filteredData" 
            :key="item.index" 
            class="bg-white rounded-2xl overflow-hidden card-shadow relative group transition-all duration-300 w-full"
        >
            <!-- Category Color Strip -->
            <div :class="['absolute left-0 top-0 bottom-0 w-2 sm:w-3', getCategoryColor(item.tag)]"></div>

            <div class="p-4 sm:p-5 pl-5 sm:pl-7">
                <!-- Header: Tag & Edit -->
                <div class="flex justify-between items-start mb-2">
                    <span :class="['text-sm font-bold px-3 py-1 rounded-full bg-opacity-10 text-opacity-100 flex items-center', getCategoryBadgeStyle(item.tag)]">
                        <!-- Added 'fas' class to ensure icon renders -->
                        <i :class="['fas mr-1', getCategoryIcon(item.tag)]"></i> 
                        {{ item.tag || 'æœªåˆ†é¡' }}
                    </span>
                    <button @click="openEditModal(item)" class="text-gray-300 hover:text-fuji-blue p-2 -mr-2 -mt-2">
                        <i class="fas fa-pen text-lg"></i>
                    </button>
                </div>

                <!-- Title -->
                <h2 class="text-2xl font-bold mb-2 text-gray-800 leading-snug">{{ item.activity }}</h2>
                
                <!-- Time: Added "é ç´„:" prefix -->
                <div v-if="item.bookingTime" class="flex items-center text-fuji-blue font-bold text-lg mb-3 bg-blue-50 w-fit px-3 py-1 rounded-lg">
                    <i class="far fa-clock mr-2"></i>
                    é ç´„: {{ item.bookingTime }}
                </div>

                <!-- Address & Navigation -->
                <div v-if="item.address" class="flex justify-between items-center mb-4">
                    <div class="flex-1 mr-3">
                        <div class="flex items-start text-gray-600">
                            <i class="fas fa-map-marker-alt mt-1 mr-2 text-gray-400 flex-shrink-0"></i>
                            <p class="text-base line-clamp-2">{{ item.address }}</p>
                        </div>
                        
                        <!-- Parking Logic -->
                        <div v-if="hasParkingInfo(item)" class="mt-2 flex items-center text-green-600 text-sm font-bold ml-6">
                            <i class="fas fa-parking mr-1"></i>
                            <span>æœ‰åœè»Šä½</span>
                        </div>
                        <div v-else class="mt-2 flex items-center text-gray-400 text-sm ml-6">
                            <i class="fas fa-question-circle mr-1"></i>
                            <a :href="`https://www.google.com/maps/search/parking+near+${item.address}`" target="_blank" class="underline decoration-dotted hover:text-fuji-blue">æ‰¾è»Šä½</a>
                        </div>
                    </div>
                    
                    <a :href="`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.activity + ' ' + item.address)}`" 
                       target="_blank"
                       class="bg-fuji-blue text-white w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0 shadow-md active:bg-blue-700 active:scale-95 transition-transform">
                        <i class="fas fa-location-arrow text-xl"></i>
                    </a>
                </div>

                <!-- Updated Notes Section Style -->
                <div v-if="item.note" class="bg-yellow-50 border-l-4 border-yellow-400 p-3 rounded-r-lg mt-3">
                    <p class="text-gray-700 text-base leading-relaxed">
                        <i class="fas fa-info-circle text-yellow-500 mr-1"></i> {{ item.note }}
                    </p>
                </div>

                <!-- Toggle Details Button (For researched info only now) -->
                <button 
                    @click="toggleExpand(item.index)" 
                    class="w-full mt-3 flex items-center justify-center py-2 text-gray-400 hover:text-fuji-blue transition-colors border-t border-gray-100">
                    <span class="text-sm font-bold mr-1">{{ expandedItems.includes(item.index) ? 'æ”¶åˆæ›´å¤šè³‡è¨Š' : 'æŸ¥çœ‹ç¶²è·¯è³‡è¨Š' }}</span>
                    <i :class="['fas transition-transform duration-300', expandedItems.includes(item.index) ? 'fa-chevron-up' : 'fa-chevron-down']"></i>
                </button>

                <!-- Expanded Content (Web Info) -->
                <div v-if="expandedItems.includes(item.index)" class="pt-2 animate-fade-in-down">
                    <div class="bg-blue-50 rounded-xl p-4">
                        <h4 class="text-sm text-fuji-blue font-bold mb-2"><i class="fab fa-google mr-1"></i>ç¶²è·¯ä¸ŠæŸ¥åˆ°çš„è³‡è¨Š</h4>
                        <div class="space-y-2">
                            <a :href="`https://www.google.com/search?q=${encodeURIComponent(item.activity + ' è©•åƒ¹')}`" target="_blank" class="block bg-white p-3 rounded-lg shadow-sm text-gray-700 flex justify-between items-center active:bg-gray-50">
                                <span><i class="fas fa-star text-yellow-400 mr-2"></i>æŸ¥çœ‹ Google è©•åƒ¹</span>
                                <i class="fas fa-external-link-alt text-gray-300 text-sm"></i>
                            </a>
                             <a :href="`https://www.instagram.com/explore/tags/${encodeURIComponent(item.activity.replace(/\s/g, ''))}/`" target="_blank" class="block bg-white p-3 rounded-lg shadow-sm text-gray-700 flex justify-between items-center active:bg-gray-50">
                                <span><i class="fab fa-instagram text-pink-500 mr-2"></i>IG ç†±é–€æ‰“å¡</span>
                                <i class="fas fa-external-link-alt text-gray-300 text-sm"></i>
                            </a>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        
        <div class="h-16"></div> <!-- Spacer -->
    </main>

    <!-- Floating Action Button (Add) -->
    <button @click="openAddModal" class="fixed bottom-8 right-6 w-16 h-16 bg-fuji-blue text-white rounded-full shadow-2xl flex items-center justify-center transform hover:scale-105 active:scale-95 transition-all z-20">
        <i class="fas fa-plus text-2xl"></i>
    </button>

    <!-- Edit/Add Modal -->
    <div v-if="isModalOpen" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <!-- Added max-h and overflow handling -->
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl flex flex-col modal-content relative">
            
            <div class="p-6 pb-2 flex justify-between items-center sticky top-0 bg-white z-10 border-b border-gray-100">
                <h3 class="text-2xl font-bold text-gray-800">{{ isEditing ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹' }}</h3>
                <button @click="closeModal" class="text-gray-400 hover:text-gray-600 p-2 bg-gray-100 rounded-full w-10 h-10 flex items-center justify-center">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="p-6 space-y-4 overflow-y-auto">
                <form @submit.prevent="submitForm" id="tripForm" class="space-y-4">
                    <!-- Day Selection -->
                    <div>
                        <label class="block text-sm font-bold text-gray-500 mb-1">å¤©æ•¸</label>
                        <div class="flex space-x-2">
                            <button type="button" @click="form.day = 1" :class="['flex-1 py-3 rounded-xl border-2 font-bold transition-colors', form.day == 1 ? 'border-fuji-blue text-fuji-blue bg-blue-50' : 'border-gray-200 text-gray-400']">Day 1</button>
                            <button type="button" @click="form.day = 2" :class="['flex-1 py-3 rounded-xl border-2 font-bold transition-colors', form.day == 2 ? 'border-fuji-blue text-fuji-blue bg-blue-50' : 'border-gray-200 text-gray-400']">Day 2</button>
                        </div>
                    </div>

                    <!-- Activity Name -->
                    <div>
                        <label class="block text-sm font-bold text-gray-500 mb-1">æ™¯é»/æ´»å‹•åç¨±</label>
                        <input v-model="form.activity" required class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-lg focus:outline-none focus:ring-2 focus:ring-fuji-blue focus:bg-white transition-colors" placeholder="ä¾‹å¦‚ï¼šæ™´ç©ºå¡”">
                    </div>

                    <!-- Tag -->
                    <div>
                        <label class="block text-sm font-bold text-gray-500 mb-1">åˆ†é¡</label>
                        <select v-model="form.tag" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-lg appearance-none focus:outline-none focus:ring-2 focus:ring-fuji-blue focus:bg-white transition-colors">
                            <option value="æ™¯é»">ğŸ—» æ™¯é»</option>
                            <option value="é£Ÿç‰©">ğŸœ é£Ÿç‰©</option>
                            <option value="è³¼ç‰©">ğŸ›ï¸ è³¼ç‰©</option>
                            <option value="äº¤é€š">ğŸš… äº¤é€š</option>
                            <option value="é…’åº—">ğŸ¨ é…’åº—</option>
                            <option value="æ´»å‹•">ğŸ§— æ´»å‹•</option>
                        </select>
                    </div>

                    <!-- Time -->
                    <div>
                        <label class="block text-sm font-bold text-gray-500 mb-1">é ç´„æ™‚é–“</label>
                        <input v-model="form.bookingTime" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-lg focus:outline-none focus:ring-2 focus:ring-fuji-blue focus:bg-white transition-colors" placeholder="ä¾‹å¦‚ï¼š14:00 (é¸å¡«)">
                    </div>

                    <!-- Address -->
                    <div>
                        <label class="block text-sm font-bold text-gray-500 mb-1">åœ°å€</label>
                        <input v-model="form.address" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-lg focus:outline-none focus:ring-2 focus:ring-fuji-blue focus:bg-white transition-colors" placeholder="è¼¸å…¥åœ°å€ä»¥é¡¯ç¤ºå°èˆª">
                    </div>

                    <!-- Note -->
                    <div>
                        <label class="block text-sm font-bold text-gray-500 mb-1">å‚™è¨»</label>
                        <textarea v-model="form.note" rows="3" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-lg focus:outline-none focus:ring-2 focus:ring-fuji-blue focus:bg-white transition-colors" placeholder="æ³¨æ„äº‹é …ã€é ç´„ä»£è™Ÿç­‰"></textarea>
                    </div>
                </form>
            </div>

            <div class="p-4 border-t border-gray-100 bg-gray-50 sticky bottom-0 z-10 rounded-b-2xl">
                <button type="submit" form="tripForm" :disabled="submitting" class="w-full bg-fuji-blue text-white font-bold py-3.5 rounded-xl shadow-lg active:scale-95 transition-transform flex justify-center items-center text-lg">
                    <span v-if="!submitting">{{ isEditing ? 'å„²å­˜è®Šæ›´' : 'æ–°å¢è¡Œç¨‹' }}</span>
                    <span v-else><i class="fas fa-circle-notch fa-spin mr-2"></i>è™•ç†ä¸­...</span>
                </button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
        setup() {
            // State
            const scheduleData = ref([]);
            const loading = ref(true);
            const currentDay = ref('1');
            const expandedItems = ref([]);
            const isModalOpen = ref(false);
            const isEditing = ref(false);
            const submitting = ref(false);

            // Google Sheet & Script Config
            const SHEET_ID = '1ldKQ9oYOyx5kpBsiuB46qh9hkpZexGk2tGp5GIHRBo4';
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzYmouRrBhVt8M-L5HcttVfKoAPdLahZAs4XoMmcRo_65-JvdxoM5LC1x_uuAZ1SUs/exec';

            // Form State
            const form = ref({
                index: '',
                day: 1,
                activity: '',
                tag: 'æ™¯é»',
                bookingTime: '',
                address: '',
                note: ''
            });

            // Fetch Data from Google Sheet using Gviz
            const fetchData = async () => {
                loading.value = true;
                try {
                    // Use standard Gviz query to get JSON
                    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
                    const response = await fetch(url);
                    const text = await response.text();
                    
                    // Parse Gviz Response (Remove "/*O_o*/ google.visualization.Query.setResponse(...);")
                    const jsonString = text.substring(47).slice(0, -2);
                    const json = JSON.parse(jsonString);
                    
                    // Map rows to clean objects
                    scheduleData.value = json.table.rows.map(row => {
                        const c = row.c;
                        return {
                            index: c[0]?.v || '', // Hidden Index
                            day: c[1]?.v || 1,
                            activity: c[2]?.v || '',
                            tag: c[3]?.v || '',
                            // Modified: Prefer formatted string 'f' if available, otherwise 'v', then empty
                            bookingTime: c[4]?.f || c[4]?.v || '', 
                            address: c[5]?.v || '',
                            note: c[6]?.v || ''
                        };
                    }).filter(item => item.activity); // Filter empty rows

                } catch (error) {
                    console.error('Error fetching data:', error);
                    alert('è®€å–è¡Œç¨‹å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚');
                } finally {
                    loading.value = false;
                }
            };

            // Helpers
            const getCategoryColor = (tag) => {
                const map = {
                    'é£Ÿç‰©': 'bg-orange-400',
                    'æ´»å‹•': 'bg-sky-500',
                    'è³¼ç‰©': 'bg-pink-400',
                    'æ™¯é»': 'bg-emerald-500',
                    'é…’åº—': 'bg-indigo-500',
                    'äº¤é€š': 'bg-slate-500'
                };
                return map[tag] || 'bg-gray-400';
            };

            const getCategoryIcon = (tag) => {
                const map = {
                    'é£Ÿç‰©': 'fa-utensils',
                    'æ´»å‹•': 'fa-person-hiking',
                    'è³¼ç‰©': 'fa-shopping-bag',
                    'æ™¯é»': 'fa-camera',
                    'é…’åº—': 'fa-bed',
                    'äº¤é€š': 'fa-train-subway'
                };
                return map[tag] || 'fa-map-marker-alt';
            };

            const getCategoryBadgeStyle = (tag) => {
                const map = {
                    'é£Ÿç‰©': 'text-orange-600 bg-orange-600',
                    'æ´»å‹•': 'text-sky-600 bg-sky-600',
                    'è³¼ç‰©': 'text-pink-600 bg-pink-600',
                    'æ™¯é»': 'text-emerald-600 bg-emerald-600',
                    'é…’åº—': 'text-indigo-600 bg-indigo-600',
                    'äº¤é€š': 'text-slate-600 bg-slate-600'
                };
                return map[tag] || 'text-gray-600 bg-gray-600';
            };

            const hasParkingInfo = (item) => {
                const keywords = ['åœè»Š', 'è»Šä½', 'Parking', 'P'];
                return keywords.some(k => (item.note || '').includes(k));
            };

            // Computed
            const filteredData = computed(() => {
                return scheduleData.value.filter(item => String(item.day) === String(currentDay.value));
            });

            // Actions
            const toggleExpand = (index) => {
                if (expandedItems.value.includes(index)) {
                    expandedItems.value = expandedItems.value.filter(i => i !== index);
                } else {
                    expandedItems.value.push(index);
                }
            };

            const openAddModal = () => {
                isEditing.value = false;
                form.value = { index: '', day: currentDay.value, activity: '', tag: 'æ™¯é»', bookingTime: '', address: '', note: '' };
                isModalOpen.value = true;
            };

            const openEditModal = (item) => {
                isEditing.value = true;
                form.value = { ...item }; // Clone data
                isModalOpen.value = true;
            };

            const closeModal = () => {
                isModalOpen.value = false;
            };

            const submitForm = async () => {
                submitting.value = true;
                
                // Construct URL Parameters
                const params = new URLSearchParams({
                    index: form.value.index,
                    day: form.value.day,
                    activity: form.value.activity,
                    tag: form.value.tag,
                    bookingTime: form.value.bookingTime,
                    address: form.value.address,
                    note: form.value.note
                });

                try {
                    // Send to Google Apps Script
                    // Using no-cors because GAS exec URLs often have CORS issues on simple fetch in browser environments
                    // However, 'no-cors' prevents reading the response.
                    // For a robust app, jsonp or a proxy is better, but this fits the "Simple Web App" requirement.
                    await fetch(`${SCRIPT_URL}?${params.toString()}`, {
                        method: 'GET',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    // Optimistic UI Update (Assume success)
                    // If editing, update local array; if adding, verify on reload or push
                    // To be safe, we reload data
                    setTimeout(async () => {
                        await fetchData();
                        closeModal();
                        submitting.value = false;
                        alert(isEditing.value ? 'æ›´æ–°æˆåŠŸï¼' : 'æ–°å¢æˆåŠŸï¼');
                    }, 1500); // Wait a bit for GAS to process

                } catch (e) {
                    console.error(e);
                    alert('å¯«å…¥ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                    submitting.value = false;
                }
            };

            // Initialize
            onMounted(() => {
                fetchData();
            });

            return {
                scheduleData,
                filteredData,
                loading,
                currentDay,
                expandedItems,
                isModalOpen,
                isEditing,
                form,
                submitting,
                getCategoryColor,
                getCategoryIcon,
                getCategoryBadgeStyle,
                hasParkingInfo,
                toggleExpand,
                openAddModal,
                openEditModal,
                closeModal,
                submitForm
            };
        }
    }).mount('#app');
</script>

<style>
/* Animations */
@keyframes slide-up {
    from { transform: translateY(100%); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}
.animate-slide-up {
    animation: slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}

@keyframes fade-in-down {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}
.animate-fade-in-down {
    animation: fade-in-down 0.2s ease-out;
}
</style>

</body>
</html>
